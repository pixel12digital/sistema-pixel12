name: ðŸš€ Deploy AutomÃ¡tico - Sistema Pixel12

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  # ========================================
  # TESTES AUTOMÃTICOS
  # ========================================
  test:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    
    steps:
    - name: ðŸ“¥ Checkout do cÃ³digo
      uses: actions/checkout@v4
      
    - name: ðŸ“¦ Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        
    - name: ðŸ“¥ Instalar dependÃªncias
      run: npm ci
      
    - name: ðŸ§ª Executar testes
      run: npm test || echo "Testes nÃ£o configurados ainda"
      
    - name: ðŸ” Linting
      run: npm run lint || echo "Linting nÃ£o configurado ainda"

  # ========================================
  # DEPLOY NA VPS
  # ========================================
  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: ðŸ“¥ Checkout do cÃ³digo
      uses: actions/checkout@v4
      
    - name: ðŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        
    - name: ðŸ“¥ Instalar dependÃªncias
      run: npm ci
      
    - name: ðŸ” Configurar SSH
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}
        
    - name: ðŸ” Validar chave SSH
      run: |
        echo "ðŸ” Validando configuraÃ§Ã£o SSH..."
        ssh-add -l || echo "âš ï¸ Nenhuma chave SSH carregada"
        echo "ðŸ“ ConteÃºdo do diretÃ³rio SSH:"
        ls -la ~/.ssh/ || echo "âš ï¸ DiretÃ³rio SSH nÃ£o encontrado"
        
    - name: ðŸŒ Adicionar VPS ao known_hosts
      run: |
        echo "ðŸ” Configurando known_hosts..."
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        
        echo "ðŸ” Testando conexÃ£o com VPS: ${{ secrets.VPS_HOST }}"
        ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || {
          echo "âš ï¸ ssh-keyscan falhou, tentando mÃ©todo alternativo..."
          ssh-keyscan ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || echo "âš ï¸ MÃ©todo alternativo tambÃ©m falhou"
        }
        
        chmod 644 ~/.ssh/known_hosts
        echo "âœ… known_hosts configurado"
        
    - name: ðŸ§ª Testar conexÃ£o SSH
      run: |
        echo "ðŸ§ª Testando conexÃ£o SSH..."
        ssh -o ConnectTimeout=10 -o BatchMode=yes ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} "echo 'âœ… ConexÃ£o SSH funcionando!'" || {
          echo "âŒ Falha na conexÃ£o SSH"
          echo "ðŸ” Verificando configuraÃ§Ã£o..."
          ssh-add -l
          echo "ðŸ“ ConteÃºdo do known_hosts:"
          cat ~/.ssh/known_hosts || echo "âš ï¸ known_hosts vazio"
          exit 1
        }
        
    - name: ðŸš€ Deploy na VPS
      run: |
        echo "ðŸš€ Iniciando deploy na VPS..."
        
        # Criar arquivo de configuraÃ§Ã£o temporÃ¡rio
        cat > .env.vps << EOF
        NODE_ENV=vps
        PORT=${{ secrets.VPS_PORT }}
        DB_HOST=${{ secrets.VPS_DB_HOST }}
        DB_PORT=${{ secrets.VPS_DB_PORT }}
        DB_USER=${{ secrets.VPS_DB_USER }}
        DB_PASS=${{ secrets.VPS_DB_PASS }}
        DB_NAME=${{ secrets.VPS_DB_NAME }}
        JWT_SECRET=${{ secrets.VPS_JWT_SECRET }}
        JWT_EXPIRES_IN=24h
        JWT_ISSUER=sistema-pixel12
        JWT_AUDIENCE=users
        BCRYPT_ROUNDS=12
        CORS_ORIGIN=*
        LOG_LEVEL=info
        ENABLE_MORGAN=true
        EOF
        
        # Fazer deploy via SSH
        ssh -o ConnectTimeout=30 -o BatchMode=yes ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'DEPLOY_SCRIPT'
          echo "ðŸ“ Navegando para diretÃ³rio do projeto..."
          cd ${{ secrets.VPS_PROJECT_PATH }}
          
          echo "ðŸ“¥ Atualizando cÃ³digo..."
          git fetch origin
          git reset --hard origin/master
          
          echo "ðŸ“¦ Instalando dependÃªncias..."
          npm ci --production
          
          echo "ðŸ—„ï¸ Configurando banco de dados..."
          cp .env.vps .env
          node setup-database.js || echo "Setup database nÃ£o encontrado"
          
          echo "ðŸ”„ Reiniciando serviÃ§os..."
          sudo systemctl restart pixel12-api || echo "âš ï¸ ServiÃ§o nÃ£o encontrado, iniciando manualmente..."
          
          echo "ðŸ§ª Testando conexÃ£o..."
          node test-vps-connection.js || echo "âš ï¸ Teste de conexÃ£o nÃ£o encontrado"
          
          echo "âœ… Deploy concluÃ­do com sucesso!"
        DEPLOY_SCRIPT
        
    - name: ðŸ“§ NotificaÃ§Ã£o de sucesso
      if: success()
      run: |
        echo "ðŸŽ‰ Deploy concluÃ­do com sucesso!"
        echo "ðŸŒ VPS: ${{ secrets.VPS_HOST }}"
        echo "ðŸ“± API: http://${{ secrets.VPS_HOST }}:${{ secrets.VPS_PORT }}"
        
    - name: ðŸ“§ NotificaÃ§Ã£o de falha
      if: failure()
      run: |
        echo "âŒ Deploy falhou!"
        echo "ðŸ” Verifique os logs acima para mais detalhes"
        echo "ðŸŒ VPS: ${{ secrets.VPS_HOST }}"
        echo "ðŸ‘¤ UsuÃ¡rio: ${{ secrets.VPS_USER }}"
        echo "ðŸ”‘ Status da chave SSH:"
        ssh-add -l || echo "âš ï¸ Nenhuma chave SSH carregada"
