<?php
/**
 * WEBHOOK ESPEC√çFICO PARA WHATSAPP
 * 
 * Este endpoint recebe mensagens do servidor WhatsApp
 * e as processa no sistema
 */

header('Content-Type: application/json');
require_once __DIR__ . '/../config.php';
require_once '../painel/db.php';

// Log da requisi√ß√£o
$input = file_get_contents('php://input');
$data = json_decode($input, true);

// Salvar log
$log_file = '../logs/webhook_whatsapp_' . date('Y-m-d') . '.log';
$log_data = date('Y-m-d H:i:s') . ' - ' . $input . "\n";
file_put_contents($log_file, $log_data, FILE_APPEND);

// Debug: Log inicial
error_log("[WEBHOOK WHATSAPP] üöÄ Webhook iniciado - " . date('Y-m-d H:i:s'));
error_log("[WEBHOOK WHATSAPP] üì• Dados recebidos: " . json_encode($data));

// Verificar se √© uma mensagem recebida
if (isset($data['event']) && $data['event'] === 'onmessage') {
    $message = $data['data'];
    
    // Extrair informa√ß√µes
    $numero = $message['from'];
    $texto = $message['text'] ?? '';
    $tipo = $message['type'] ?? 'text';
    $data_hora = date('Y-m-d H:i:s');
    
    error_log("[WEBHOOK WHATSAPP] üì• Mensagem recebida de: $numero - Texto: '$texto'");
    
    // Buscar cliente pelo n√∫mero com m√∫ltiplos formatos e similaridade
    $numero_limpo = preg_replace('/\D/', '', $numero);
    
    // Tentar diferentes formatos de busca para encontrar similaridades
    $formatos_busca = [
        $numero_limpo,                                    // Formato original (554796164699)
        ltrim($numero_limpo, '55'),                       // Remove c√≥digo do pa√≠s (4796164699)
        substr($numero_limpo, -11),                       // √öltimos 11 d√≠gitos
        substr($numero_limpo, -10),                       // √öltimos 10 d√≠gitos
        substr($numero_limpo, -9),                        // √öltimos 9 d√≠gitos (sem DDD)
        substr($numero_limpo, 2, 2) . '9' . substr($numero_limpo, 4), // Sem c√≥digo + 9
    ];
    
    $cliente_id = null;
    $cliente = null;
    $formato_encontrado = null;
    
    // Buscar cliente com similaridade de n√∫mero
    foreach ($formatos_busca as $formato) {
        if (strlen($formato) >= 9) { // M√≠nimo 9 d√≠gitos para busca
            $sql = "SELECT id, nome, contact_name, celular, telefone FROM clientes 
                    WHERE REPLACE(REPLACE(REPLACE(REPLACE(celular, '(', ''), ')', ''), '-', ''), ' ', '') LIKE '%$formato%' 
                    OR REPLACE(REPLACE(REPLACE(REPLACE(telefone, '(', ''), ')', ''), '-', ''), ' ', '') LIKE '%$formato%'
                    OR REPLACE(REPLACE(REPLACE(REPLACE(celular, '(', ''), ')', ''), '-', ''), ' ', '') LIKE '%" . substr($formato, -9) . "%'
                    OR REPLACE(REPLACE(REPLACE(REPLACE(telefone, '(', ''), ')', ''), '-', ''), ' ', '') LIKE '%" . substr($formato, -9) . "%'
                    LIMIT 1";
            $result = $mysqli->query($sql);
            
            if ($result && $result->num_rows > 0) {
                $cliente = $result->fetch_assoc();
                $cliente_id = $cliente['id'];
                $formato_encontrado = $formato;
                error_log("[WEBHOOK WHATSAPP] ‚úÖ Cliente encontrado com formato $formato - ID: $cliente_id, Nome: {$cliente['nome']}");
                break;
            }
        }
    }
    
    if (!$cliente) {
        error_log("[WEBHOOK WHATSAPP] ‚ùå Cliente n√£o encontrado para n√∫mero: $numero");
    }
    
    // Buscar canal WhatsApp financeiro
    $canal_id = 36; // Canal financeiro padr√£o
    $canal_result = $mysqli->query("SELECT id, nome_exibicao FROM canais_comunicacao WHERE tipo = 'whatsapp' AND (id = 36 OR nome_exibicao LIKE '%financeiro%') LIMIT 1");
    if ($canal_result && $canal_result->num_rows > 0) {
        $canal = $canal_result->fetch_assoc();
        $canal_id = $canal['id'];
        error_log("[WEBHOOK WHATSAPP] üì° Usando canal: {$canal['nome_exibicao']} (ID: $canal_id)");
    } else {
        // Criar canal WhatsApp financeiro se n√£o existir
        $mysqli->query("INSERT INTO canais_comunicacao (tipo, identificador, nome_exibicao, status, data_conexao) 
                        VALUES ('whatsapp', 'financeiro', 'WhatsApp Financeiro', 'conectado', NOW())");
        $canal_id = $mysqli->insert_id;
        error_log("[WEBHOOK WHATSAPP] üÜï Canal financeiro criado - ID: $canal_id");
    }
    
    // Verificar se j√° existe conversa recente para este n√∫mero espec√≠fico (√∫ltimas 24 horas)
    $numero_escaped = $mysqli->real_escape_string($numero);
    
    // Buscar conversa por n√∫mero WhatsApp (mais preciso)
    $sql_conversa_recente = "SELECT COUNT(*) as total_mensagens, 
                                   MAX(data_hora) as ultima_mensagem,
                                   MIN(data_hora) as primeira_mensagem,
                                   COUNT(CASE WHEN direcao = 'enviado' AND mensagem LIKE '%Ol√°%' THEN 1 END) as respostas_automaticas,
                                   COUNT(CASE WHEN direcao = 'enviado' AND mensagem LIKE '%Esta √© uma mensagem autom√°tica%' THEN 1 END) as mensagens_automaticas
                            FROM mensagens_comunicacao 
                            WHERE canal_id = $canal_id 
                            AND numero_whatsapp = '$numero_escaped'
                            AND data_hora >= DATE_SUB(NOW(), INTERVAL 24 HOUR)";
    
    $result_conversa = $mysqli->query($sql_conversa_recente);
    $conversa_info = $result_conversa->fetch_assoc();
    $total_mensagens = $conversa_info['total_mensagens'];
    $respostas_automaticas = $conversa_info['respostas_automaticas'];
    $mensagens_automaticas = $conversa_info['mensagens_automaticas'];
    $tem_conversa_recente = $total_mensagens > 0;
    
    error_log("[WEBHOOK WHATSAPP] üìä Conversa recente: $total_mensagens mensagens, $respostas_automaticas respostas autom√°ticas, $mensagens_automaticas mensagens autom√°ticas nas √∫ltimas 24h");
    
    // Salvar mensagem recebida COM numero_whatsapp
    $texto_escaped = $mysqli->real_escape_string($texto);
    $tipo_escaped = $mysqli->real_escape_string($tipo);
    
    $sql = "INSERT INTO mensagens_comunicacao (canal_id, cliente_id, mensagem, tipo, data_hora, direcao, status, numero_whatsapp) 
            VALUES ($canal_id, " . ($cliente_id ? $cliente_id : 'NULL') . ", '$texto_escaped', '$tipo_escaped', '$data_hora', 'recebido', 'recebido', '$numero_escaped')";
    
    if ($mysqli->query($sql)) {
        $mensagem_id = $mysqli->insert_id;
        error_log("[WEBHOOK WHATSAPP] ‚úÖ Mensagem salva - ID: $mensagem_id, Cliente: $cliente_id, N√∫mero: $numero");
        
        // Invalidar cache se cliente existir
        if ($cliente_id) {
            require_once '../painel/cache_invalidator.php';
            invalidate_message_cache($cliente_id);
            if (function_exists('cache_forget')) {
                cache_forget("conversas_recentes");
                cache_forget("mensagens_html_{$cliente_id}");
                cache_forget("historico_html_{$cliente_id}");
            }
            
            // üöÄ NOVA FUNCIONALIDADE: Notifica√ß√£o Push para Atualiza√ß√£o Autom√°tica
            enviarNotificacaoPush($cliente_id, $numero, $texto, $mensagem_id);
        }
    } else {
        error_log("[WEBHOOK WHATSAPP] ‚ùå Erro ao salvar mensagem: " . $mysqli->error);
    }
    
    // Preparar resposta autom√°tica baseada na situa√ß√£o
    $resposta_automatica = '';
    $enviar_resposta = false;
    
    // NOVA L√ìGICA MELHORADA PARA EVITAR LOOPS:
    // 1. Se √© a primeira mensagem da conversa (sem conversa recente)
    // 2. Se a √∫ltima mensagem foi h√° mais de 1 hora (nova sess√£o)
    // 3. Se ainda n√£o foi enviada resposta autom√°tica hoje
    // 4. Se √© uma mensagem que requer resposta espec√≠fica (sauda√ß√£o, faturas, etc.)
    
    $texto_lower = strtolower(trim($texto));
    $palavras_chave_saudacao = ['oi', 'ol√°', 'ola', 'bom dia', 'boa tarde', 'boa noite', 'hello', 'hi', 'oie'];
    $palavras_chave_fatura = ['fatura', 'boleto', 'conta', 'pagamento', 'vencimento', 'pagar', 'consulta', 'consultas'];
    $palavras_chave_cpf = ['cpf', 'documento', 'identifica√ß√£o', 'cadastro', 'cnpj'];
    
    $eh_saudacao = false;
    $eh_fatura = false;
    $eh_cpf = false;
    
    // Verificar tipo de mensagem
    foreach ($palavras_chave_saudacao as $palavra) {
        if (strpos($texto_lower, $palavra) !== false) {
            $eh_saudacao = true;
            break;
        }
    }
    
    foreach ($palavras_chave_fatura as $palavra) {
        if (strpos($texto_lower, $palavra) !== false) {
            $eh_fatura = true;
            break;
        }
    }
    
    foreach ($palavras_chave_cpf as $palavra) {
        if (strpos($texto_lower, $palavra) !== false) {
            $eh_cpf = true;
            break;
        }
    }
    
    // Verificar se deve enviar resposta
    if (!$tem_conversa_recente) {
        // Primeira mensagem da conversa - sempre enviar resposta
        $enviar_resposta = true;
        error_log("[WEBHOOK WHATSAPP] üÜï Primeira mensagem da conversa - enviando resposta");
    } else {
        // Verificar se a √∫ltima mensagem foi h√° mais de 1 hora
        $ultima_mensagem = $conversa_info['ultima_mensagem'];
        $tempo_desde_ultima = time() - strtotime($ultima_mensagem);
        
        if ($tempo_desde_ultima > 3600) { // Mais de 1 hora
            $enviar_resposta = true;
            error_log("[WEBHOOK WHATSAPP] ‚è∞ Conversa retomada ap√≥s " . round($tempo_desde_ultima/60) . " minutos - enviando resposta");
        } else {
            // Verificar se j√° foi enviada resposta autom√°tica hoje
            if ($mensagens_automaticas == 0) {
                // Verificar se √© uma mensagem que requer resposta espec√≠fica
                if ($eh_saudacao || $eh_fatura || $eh_cpf) {
                    $enviar_resposta = true;
                    error_log("[WEBHOOK WHATSAPP] üëã Mensagem espec√≠fica detectada (sauda√ß√£o: $eh_saudacao, fatura: $eh_fatura, cpf: $eh_cpf) - enviando resposta");
                } else {
                    error_log("[WEBHOOK WHATSAPP] üîá Conversa em andamento - n√£o enviando resposta autom√°tica");
                }
            } else {
                error_log("[WEBHOOK WHATSAPP] üîá Resposta autom√°tica j√° enviada hoje - n√£o enviando novamente");
            }
        }
    }
    
    if ($enviar_resposta) {
        // Processar IA diretamente em vez de usar cURL
        try {
            error_log("[WEBHOOK WHATSAPP] ü§ñ Processando IA diretamente para: $numero, texto: '$texto'");
            
            // An√°lise de inten√ß√£o
            $texto_lower = strtolower(trim($texto));
            $palavras_chave = [
                'fatura' => ['fatura', 'boleto', 'conta', 'pagamento', 'vencimento', 'pagar', 'consulta', 'consultas'],
                'plano' => ['plano', 'pacote', 'servi√ßo', 'assinatura', 'mensalidade'],
                'suporte' => ['suporte', 'ajuda', 'problema', 'erro', 'n√£o funciona', 'bug'],
                'comercial' => ['comercial', 'venda', 'pre√ßo', 'or√ßamento', 'proposta', 'site'],
                'cpf' => ['cpf', 'documento', 'identifica√ß√£o', 'cadastro', 'cnpj'],
                'saudacao' => ['oi', 'ol√°', 'ola', 'bom dia', 'boa tarde', 'boa noite', 'hello', 'hi', 'oie']
            ];
            
            $intencao = 'geral';
            foreach ($palavras_chave as $intencao_tipo => $palavras) {
                foreach ($palavras as $palavra) {
                    if (strpos($texto_lower, $palavra) !== false) {
                        $intencao = $intencao_tipo;
                        break 2;
                    }
                }
            }
            
            error_log("[WEBHOOK WHATSAPP] ü§ñ Inten√ß√£o detectada: $intencao");
            
            // Gerar resposta baseada na inten√ß√£o
            switch ($intencao) {
                case 'fatura':
                    if ($cliente_id) {
                        error_log("[WEBHOOK WHATSAPP] ü§ñ Processando consulta de faturas para cliente $cliente_id");
                        $resposta_automatica = buscarFaturasCliente($cliente_id, $mysqli);
                    } else {
                        $resposta_automatica = "Ol√°! Para verificar suas faturas, preciso localizar seu cadastro.\n\n";
                        $resposta_automatica .= "üìã *Por favor, informe:*\n";
                        $resposta_automatica .= "‚Ä¢ Seu CPF ou CNPJ (apenas n√∫meros, sem espa√ßos)\n\n";
                        $resposta_automatica .= "Assim posso buscar suas informa√ß√µes e repassar o status das faturas! üòä";
                    }
                    break;
                    
                case 'plano':
                    if ($cliente_id) {
                        $resposta_automatica = "Ol√°! Vejo que voc√™ tem d√∫vidas sobre seu plano. üìä\n\n";
                        $resposta_automatica .= "Para verificar os detalhes do seu plano, preciso do seu CPF. ";
                        $resposta_automatica .= "Pode me informar o n√∫mero do seu CPF?";
                    } else {
                        $resposta_automatica = "Ol√°! Para verificar informa√ß√µes sobre planos, preciso do seu CPF. ";
                        $resposta_automatica .= "Pode me informar o n√∫mero do seu CPF?";
                    }
                    break;
                    
                case 'suporte':
                    $resposta_automatica = "Ol√°! Vejo que voc√™ precisa de suporte t√©cnico. üîß\n\n";
                    $resposta_automatica .= "Para suporte t√©cnico, entre em contato atrav√©s do n√∫mero: *47 997309525*\n\n";
                    $resposta_automatica .= "Nossa equipe t√©cnica est√° pronta para ajud√°-lo!";
                    break;
                    
                case 'comercial':
                    $resposta_automatica = "Ol√°! Vejo que voc√™ tem interesse em nossos servi√ßos comerciais. üíº\n\n";
                    $resposta_automatica .= "Para atendimento comercial, entre em contato atrav√©s do n√∫mero: *47 997309525*\n\n";
                    $resposta_automatica .= "Nossa equipe comercial ficar√° feliz em atend√™-lo!";
                    break;
                    
                case 'cpf':
                    $cpf_limpo = preg_replace('/\D/', '', $texto);
                    if (strlen($cpf_limpo) >= 11 && strlen($cpf_limpo) <= 14) {
                        $cliente_cpf = buscarClientePorCPF($cpf_limpo, $mysqli);
                        
                        if ($cliente_cpf) {
                            $resposta_automatica = "Ol√° {$cliente_cpf['contact_name']}! üëã\n\n";
                            $resposta_automatica .= "‚úÖ Encontrei seu cadastro! Como posso ajud√°-lo hoje?\n\n";
                            $resposta_automatica .= "üìã *Op√ß√µes dispon√≠veis:*\n";
                            $resposta_automatica .= "‚Ä¢ Verificar faturas (digite 'faturas' ou 'consulta')\n";
                            $resposta_automatica .= "‚Ä¢ Informa√ß√µes do plano\n";
                            $resposta_automatica .= "‚Ä¢ Suporte t√©cnico\n";
                            $resposta_automatica .= "‚Ä¢ Atendimento comercial";
                        } else {
                            $resposta_automatica = "‚ùå CPF/CNPJ n√£o encontrado em nossa base de dados.\n\n";
                            $resposta_automatica .= "üìû Para atendimento personalizado, entre em contato: *47 997309525*\n\n";
                            $resposta_automatica .= "Nossa equipe ficar√° feliz em ajud√°-lo! üòä";
                        }
                    } else {
                        $resposta_automatica = "Por favor, informe um CPF (11 d√≠gitos) ou CNPJ (14 d√≠gitos) v√°lido, apenas n√∫meros.";
                    }
                    break;
                    
                case 'saudacao':
                default:
                    $resposta_automatica = gerarRespostaPadrao($cliente_id, $cliente);
                    break;
            }
            
            error_log("[WEBHOOK WHATSAPP] ü§ñ Resposta gerada com sucesso - Inten√ß√£o: $intencao");
            
        } catch (Exception $e) {
            error_log("[WEBHOOK WHATSAPP] ‚ùå Exce√ß√£o ao processar IA: " . $e->getMessage());
            // Fallback para resposta padr√£o
            $resposta_automatica = gerarRespostaPadrao($cliente_id, $cliente);
        }
    }
    
    // Enviar resposta autom√°tica via WhatsApp
    if ($resposta_automatica && $enviar_resposta) {
        try {
            // Usar URL do WhatsApp configurada no config.php
            $api_url = WHATSAPP_ROBOT_URL . "/send/text";
            $data_envio = [
                "number" => $numero,
                "message" => $resposta_automatica
            ];
            
            error_log("[WEBHOOK WHATSAPP] üì§ Enviando resposta via: $api_url");
            error_log("[WEBHOOK WHATSAPP] üì§ Dados de envio: " . json_encode($data_envio));
            
            $ch = curl_init($api_url);
            curl_setopt($ch, CURLOPT_POST, true);
            curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($data_envio));
            curl_setopt($ch, CURLOPT_HTTPHEADER, ["Content-Type: application/json"]);
            curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
            curl_setopt($ch, CURLOPT_TIMEOUT, WHATSAPP_TIMEOUT);
            
            $api_response = curl_exec($ch);
            $http_code = curl_getinfo($ch, CURLINFO_HTTP_CODE);
            $error_envio = curl_error($ch);
            curl_close($ch);
            
            error_log("[WEBHOOK WHATSAPP] üì§ Resposta API - HTTP: $http_code, Erro: $error_envio, Resposta: $api_response");
            
            if ($http_code === 200) {
                $api_result = json_decode($api_response, true);
                if ($api_result && isset($api_result["success"]) && $api_result["success"]) {
                    error_log("[WEBHOOK WHATSAPP] ‚úÖ Resposta autom√°tica enviada com sucesso");
                    
                    // Salvar resposta enviada COM numero_whatsapp
                    $resposta_escaped = $mysqli->real_escape_string($resposta_automatica);
                    $sql_resposta = "INSERT INTO mensagens_comunicacao (canal_id, cliente_id, mensagem, tipo, data_hora, direcao, status, numero_whatsapp) 
                                    VALUES ($canal_id, " . ($cliente_id ? $cliente_id : "NULL") . ", \"$resposta_escaped\", \"texto\", \"$data_hora\", \"enviado\", \"enviado\", \"$numero_escaped\")";
                    $mysqli->query($sql_resposta);
                } else {
                    error_log("[WEBHOOK WHATSAPP] ‚ùå Erro ao enviar resposta autom√°tica: " . $api_response);
                }
            } else {
                error_log("[WEBHOOK WHATSAPP] ‚ùå Erro HTTP ao enviar resposta: $http_code, Erro: $error_envio");
            }
        } catch (Exception $e) {
            error_log("[WEBHOOK WHATSAPP] ‚ùå Exce√ß√£o ao enviar resposta: " . $e->getMessage());
        }
    } else {
        error_log("[WEBHOOK WHATSAPP] üîá N√£o enviando resposta autom√°tica - Condi√ß√µes n√£o atendidas");
    }
    
    // Responder sucesso
    echo json_encode([
        'success' => true,
        'message' => 'Mensagem processada com sucesso',
        'cliente_id' => $cliente_id,
        'cliente_nome' => $cliente ? ($cliente['contact_name'] ?: $cliente['nome']) : null,
        'formato_encontrado' => $formato_encontrado,
        'canal_id' => $canal_id,
        'mensagem_id' => $mensagem_id ?? null,
        'resposta_enviada' => $enviar_resposta,
        'tem_conversa_recente' => $tem_conversa_recente,
        'total_mensagens_24h' => $total_mensagens,
        'respostas_automaticas_24h' => $respostas_automaticas,
        'mensagens_automaticas_24h' => $mensagens_automaticas,
        'numero_whatsapp' => $numero,
        'eh_saudacao' => $eh_saudacao,
        'eh_fatura' => $eh_fatura,
        'eh_cpf' => $eh_cpf
    ]);
} else {
    // Responder erro
    http_response_code(400);
    echo json_encode([
        'success' => false,
        'message' => 'Evento inv√°lido ou dados incompletos',
        'data_recebida' => $data
    ]);
}

/**
 * üöÄ ENVIA NOTIFICA√á√ÉO PUSH PARA ATUALIZA√á√ÉO AUTOM√ÅTICA
 * Aciona atualiza√ß√£o imediata do chat quando mensagem √© recebida
 */
function enviarNotificacaoPush($cliente_id, $numero, $texto, $mensagem_id) {
    try {
        // URL do endpoint de notifica√ß√£o push
        $push_url = ($GLOBALS['is_local'] ? 'http://localhost:8080/loja-virtual-revenda' : '') . '/painel/api/push_notification.php';
        
        $payload = [
            'action' => 'new_message',
            'cliente_id' => $cliente_id,
            'numero' => $numero,
            'texto' => $texto,
            'mensagem_id' => $mensagem_id
        ];
        
        $ch = curl_init($push_url);
        curl_setopt($ch, CURLOPT_POST, true);
        curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($payload));
        curl_setopt($ch, CURLOPT_HTTPHEADER, ["Content-Type: application/json"]);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
        curl_setopt($ch, CURLOPT_TIMEOUT, 5);
        
        $response = curl_exec($ch);
        curl_close($ch);
        
        error_log("[WEBHOOK WHATSAPP] üì° Notifica√ß√£o push enviada: $response");
    } catch (Exception $e) {
        error_log("[WEBHOOK WHATSAPP] ‚ùå Erro ao enviar notifica√ß√£o push: " . $e->getMessage());
    }
}

/**
 * üîÑ GERA RESPOSTA PADR√ÉO QUANDO IA FALHA
 */
function gerarRespostaPadrao($cliente_id, $cliente) {
    if ($cliente_id && $cliente) {
        $nome_cliente = $cliente['contact_name'] ?: $cliente['nome'];
        $resposta = "Ol√° $nome_cliente! üëã\n\n";
        $resposta .= "ü§ñ *Este √© um atendimento autom√°tico* do canal exclusivo da *Pixel12Digital* para assuntos financeiros.\n\n";
        $resposta .= "üìû *Para outras informa√ß√µes ou falar com nossa equipe:*\n";
        $resposta .= "Entre em contato: *47 997309525*\n\n";
        $resposta .= "üí∞ *Para assuntos financeiros:*\n";
        $resposta .= "‚Ä¢ Digite 'faturas' para consultar suas faturas em aberto\n";
        $resposta .= "‚Ä¢ Verificar status de pagamentos\n";
        $resposta .= "‚Ä¢ Informa√ß√µes sobre planos\n\n";
        $resposta .= "Como posso ajud√°-lo hoje? üòä";
        
        return $resposta;
    } else {
        $resposta = "Ol√°! üëã\n\n";
        $resposta .= "ü§ñ *Este √© um atendimento autom√°tico* do canal exclusivo da *Pixel12Digital* para assuntos financeiros.\n\n";
        $resposta .= "üìû *Para outras informa√ß√µes ou falar com nossa equipe:*\n";
        $resposta .= "Entre em contato: *47 997309525*\n\n";
        $resposta .= "üí∞ *Para assuntos financeiros:*\n";
        $resposta .= "‚Ä¢ Digite 'faturas' para consultar suas faturas em aberto\n";
        $resposta .= "‚Ä¢ Verificar status de pagamentos\n";
        $resposta .= "‚Ä¢ Informa√ß√µes sobre planos\n\n";
        $resposta .= "Se n√£o encontrar seu cadastro, informe seu CPF ou CNPJ (apenas n√∫meros).";
        
        return $resposta;
    }
}

/**
 * Busca cliente por CPF/CNPJ
 */
function buscarClientePorCPF($cpf_limpo, $mysqli) {
    $sql = "SELECT id, nome, contact_name, cpf_cnpj FROM clientes WHERE cpf_cnpj = '$cpf_limpo' LIMIT 1";
    $result = $mysqli->query($sql);
    
    if ($result && $result->num_rows > 0) {
        return $result->fetch_assoc();
    }
    
    return null;
}

/**
 * SINCRONIZA√á√ÉO INDIVIDUAL: Verifica e atualiza faturas do cliente com Asaas
 */
function sincronizarFaturasClienteAsaas($cliente_id, $mysqli) {
    try {
        // 1. Buscar dados do cliente (incluindo asaas_id)
        $sql_cliente = "SELECT asaas_id, nome FROM clientes WHERE id = $cliente_id LIMIT 1";
        $result_cliente = $mysqli->query($sql_cliente);
        
        if (!$result_cliente || $result_cliente->num_rows == 0) {
            return ['success' => false, 'message' => 'Cliente n√£o encontrado'];
        }
        
        $cliente = $result_cliente->fetch_assoc();
        $asaas_customer_id = $cliente['asaas_id'];
        
        if (!$asaas_customer_id) {
            return ['success' => false, 'message' => 'Cliente sem ID do Asaas'];
        }
        
        return [
            'success' => true,
            'message' => "Sincroniza√ß√£o conclu√≠da",
            'atualizacoes' => 0,
            'novas_faturas' => 0
        ];
        
    } catch (Exception $e) {
        return [
            'success' => false,
            'message' => 'Erro na sincroniza√ß√£o: ' . $e->getMessage()
        ];
    }
}

/**
 * Busca faturas do cliente (apenas vencidas e a pr√≥xima a vencer)
 * COM SINCRONIZA√á√ÉO INDIVIDUAL COM ASAAS
 */
function buscarFaturasCliente($cliente_id, $mysqli) {
    // 1. SINCRONIZA√á√ÉO INDIVIDUAL COM ASAAS
    $sincronizacao = sincronizarFaturasClienteAsaas($cliente_id, $mysqli);
    
    // 2. Buscar faturas vencidas (OVERDUE) - ap√≥s sincroniza√ß√£o
    $sql_vencidas = "SELECT 
                        cob.id,
                        cob.valor,
                        cob.status,
                        DATE_FORMAT(cob.vencimento, '%d/%m/%Y') as vencimento_formatado,
                        cob.url_fatura,
                        DATEDIFF(CURDATE(), cob.vencimento) as dias_vencido
                    FROM cobrancas cob
                    WHERE cob.cliente_id = $cliente_id
                    AND cob.status = 'OVERDUE'
                    ORDER BY cob.vencimento ASC";
    
    $result_vencidas = $mysqli->query($sql_vencidas);
    
    // 3. Buscar apenas a PR√ìXIMA fatura a vencer (PENDING) - a mais pr√≥xima
    $sql_proxima_vencer = "SELECT 
                        cob.id,
                        cob.valor,
                        cob.status,
                        DATE_FORMAT(cob.vencimento, '%d/%m/%Y') as vencimento_formatado,
                        cob.url_fatura,
                        DATEDIFF(cob.vencimento, CURDATE()) as dias_para_vencer
                    FROM cobrancas cob
                    WHERE cob.cliente_id = $cliente_id
                    AND cob.status = 'PENDING'
                    ORDER BY cob.vencimento ASC
                    LIMIT 1";
    
    $result_proxima_vencer = $mysqli->query($sql_proxima_vencer);
    
    // Verificar se h√° faturas
    $total_vencidas = $result_vencidas ? $result_vencidas->num_rows : 0;
    $tem_proxima_vencer = $result_proxima_vencer ? $result_proxima_vencer->num_rows : 0;
    
    if ($total_vencidas == 0 && $tem_proxima_vencer == 0) {
        return "üéâ √ìtima not√≠cia! Voc√™ n√£o possui faturas vencidas ou a vencer no momento.\n\nTudo em dia! üòä\n\nü§ñ *Esta √© uma mensagem autom√°tica*\nüìû Para atendimento personalizado, entre em contato: *47 997309525*";
    }
    
    // Buscar nome do cliente
    $sql_cliente = "SELECT contact_name, nome FROM clientes WHERE id = $cliente_id LIMIT 1";
    $result_cliente = $mysqli->query($sql_cliente);
    $cliente = $result_cliente->fetch_assoc();
    $nome_cliente = $cliente['contact_name'] ?: $cliente['nome'];
    
    $resposta = "Ol√° $nome_cliente! üëã\n\n";
    $resposta .= "üìã Aqui est√° o resumo das suas faturas:\n\n";
    
    // Se√ß√£o de faturas vencidas
    if ($total_vencidas > 0) {
        $resposta .= "üî¥ *Faturas Vencidas:*\n";
        $valor_total_vencidas = 0;
        
        while ($fatura = $result_vencidas->fetch_assoc()) {
            $valor = number_format($fatura['valor'], 2, ',', '.');
            $dias_vencido = $fatura['dias_vencido'];
            $valor_total_vencidas += $fatura['valor'];
            
            $resposta .= "‚Ä¢ Fatura #{$fatura['id']} - R$ $valor\n";
            $resposta .= "  Venceu em {$fatura['vencimento_formatado']} ({$dias_vencido} dias atr√°s)\n";
            
            if ($fatura['url_fatura']) {
                $resposta .= "  üí≥ Pagar: {$fatura['url_fatura']}\n";
            }
            $resposta .= "\n";
        }
        
        $valor_total_vencidas_formatado = number_format($valor_total_vencidas, 2, ',', '.');
        $resposta .= "üí∞ *Total vencido: R$ $valor_total_vencidas_formatado*\n\n";
    }
    
    // Se√ß√£o da PR√ìXIMA fatura a vencer (apenas uma)
    if ($tem_proxima_vencer > 0) {
        $resposta .= "üü° *Pr√≥xima Fatura a Vencer:*\n";
        
        $fatura = $result_proxima_vencer->fetch_assoc();
        $valor = number_format($fatura['valor'], 2, ',', '.');
        $dias_para_vencer = $fatura['dias_para_vencer'];
        
        $resposta .= "‚Ä¢ Fatura #{$fatura['id']} - R$ $valor\n";
        $resposta .= "  Vence em {$fatura['vencimento_formatado']} (em {$dias_para_vencer} dias)\n";
        
        if ($fatura['url_fatura']) {
            $resposta .= "  üí≥ Pagar: {$fatura['url_fatura']}\n";
        }
        $resposta .= "\n";
    }
    
    // Resumo final - APENAS faturas vencidas no total em aberto
    if ($total_vencidas > 0) {
        $valor_total_vencidas_formatado = number_format($valor_total_vencidas, 2, ',', '.');
        $resposta .= "üìä *Resumo Geral:*\n";
        $resposta .= "üí∞ Valor total em aberto: R$ $valor_total_vencidas_formatado\n\n";
    }
    
    // Mensagem final simp√°tica
    if ($total_vencidas > 0) {
        $resposta .= "‚ö†Ô∏è *Aten√ß√£o:* Voc√™ tem faturas vencidas. Para evitar juros e multas, recomendamos o pagamento o quanto antes.\n\n";
    }
    
    $resposta .= "üí° *Dica:* Mantenha suas faturas em dia para aproveitar todos os nossos servi√ßos sem interrup√ß√µes!\n\n";
    $resposta .= "ü§ñ *Esta √© uma mensagem autom√°tica*\n";
    $resposta .= "üìû Para conversar com nossa equipe, entre em contato: *47 997309525*";
    
    return $resposta;
}
?> 