<?php
/**
 * üîç AVERIGUA√á√ÉO COMPLETA DO C√ìDIGO LOCAL E AJUSTE DA VPS
 * 
 * Script para analisar todo o c√≥digo local e ajustar a VPS de acordo
 * Baseado na an√°lise completa do projeto
 */

echo "üîç AVERIGUA√á√ÉO COMPLETA DO C√ìDIGO LOCAL E AJUSTE DA VPS\n";
echo "=====================================================\n\n";

// ===== 1. AN√ÅLISE DO ARQUIVO CONFIG.PHP =====
echo "1Ô∏è‚É£ ANALISANDO CONFIGURA√á√ïES PRINCIPAIS (config.php)\n";
echo "------------------------------------------------\n";

require_once 'config.php';

echo "üìã CONFIGURA√á√ïES IDENTIFICADAS:\n";
echo "‚Ä¢ WHATSAPP_ROBOT_URL: " . (defined('WHATSAPP_ROBOT_URL') ? WHATSAPP_ROBOT_URL : 'N√ÉO DEFINIDO') . "\n";
echo "‚Ä¢ WHATSAPP_TIMEOUT: " . (defined('WHATSAPP_TIMEOUT') ? WHATSAPP_TIMEOUT : 'N√ÉO DEFINIDO') . "\n";
echo "‚Ä¢ DB_HOST: " . (defined('DB_HOST') ? DB_HOST : 'N√ÉO DEFINIDO') . "\n";
echo "‚Ä¢ DB_NAME: " . (defined('DB_NAME') ? DB_NAME : 'N√ÉO DEFINIDO') . "\n";
echo "‚Ä¢ ASAAS_API_KEY: " . (defined('ASAAS_API_KEY') ? substr(ASAAS_API_KEY, 0, 20) . '...' : 'N√ÉO DEFINIDO') . "\n";
echo "‚Ä¢ DEBUG_MODE: " . (defined('DEBUG_MODE') ? (DEBUG_MODE ? 'true' : 'false') : 'N√ÉO DEFINIDO') . "\n\n";

// ===== 2. AN√ÅLISE DOS CANAIS NO BANCO DE DADOS =====
echo "2Ô∏è‚É£ ANALISANDO CANAIS NO BANCO DE DADOS\n";
echo "--------------------------------------\n";

try {
    $mysqli = new mysqli(DB_HOST, DB_USER, DB_PASS, DB_NAME);
    
    if ($mysqli->connect_error) {
        echo "‚ùå Erro de conex√£o com banco: " . $mysqli->connect_error . "\n\n";
    } else {
        echo "‚úÖ Conectado ao banco de dados\n";
        
        // Buscar canais de comunica√ß√£o
        $sql = "SELECT * FROM canais_comunicacao WHERE tipo = 'whatsapp' ORDER BY id";
        $result = $mysqli->query($sql);
        
        if ($result && $result->num_rows > 0) {
            echo "üìä CANAIS ENCONTRADOS NO BANCO:\n";
            while ($row = $result->fetch_assoc()) {
                echo "   ID: {$row['id']} | Nome: {$row['nome_exibicao']} | Identificador: {$row['identificador']}\n";
                echo "   Status: {$row['status']} | Porta: " . ($row['porta'] ?? 'N/A') . " | Sess√£o: " . ($row['sessao'] ?? 'N/A') . "\n";
                echo "   Endpoint: " . ($row['endpoint'] ?? 'N/A') . "\n";
                echo "   Data Conex√£o: " . ($row['data_conexao'] ?? 'N/A') . "\n\n";
            }
        } else {
            echo "‚ö†Ô∏è Nenhum canal WhatsApp encontrado no banco\n\n";
        }
    }
} catch (Exception $e) {
    echo "‚ùå Erro ao acessar banco: " . $e->getMessage() . "\n\n";
}

// ===== 3. AN√ÅLISE DOS WEBHOOKS NO C√ìDIGO =====
echo "3Ô∏è‚É£ ANALISANDO WEBHOOKS NO C√ìDIGO\n";
echo "--------------------------------\n";

$webhook_files = [
    'painel/receber_mensagem_ana_local.php' => 'Webhook Principal (Ana)',
    'painel/receber_mensagem.php' => 'Webhook Alternativo',
    'api/webhook_whatsapp.php' => 'Webhook API',
    'api/webhook.php' => 'Webhook Gen√©rico'
];

$webhooks_encontrados = [];

foreach ($webhook_files as $file => $description) {
    if (file_exists($file)) {
        $content = file_get_contents($file);
        $webhooks_encontrados[$file] = [
            'description' => $description,
            'exists' => true,
            'size' => strlen($content),
            'has_ana_integration' => strpos($content, 'integrador_ana') !== false,
            'has_webhook_processing' => strpos($content, 'webhook') !== false
        ];
        echo "‚úÖ $description: $file (" . strlen($content) . " bytes)\n";
    } else {
        echo "‚ùå $description: $file (N√ÉO ENCONTRADO)\n";
    }
}
echo "\n";

// ===== 4. AN√ÅLISE DOS ENDPOINTS DA API =====
echo "4Ô∏è‚É£ ANALISANDO ENDPOINTS DA API WHATSAPP\n";
echo "---------------------------------------\n";

$api_files = [
    'whatsapp-api-server.js' => 'API Principal',
    'funcao_envio_whatsapp.php' => 'Fun√ß√£o de Envio',
    'painel/ajax_whatsapp.php' => 'AJAX WhatsApp'
];

$endpoints_encontrados = [];

foreach ($api_files as $file => $description) {
    if (file_exists($file)) {
        $content = file_get_contents($file);
        $endpoints_encontrados[$file] = [
            'description' => $description,
            'exists' => true,
            'size' => strlen($content),
            'has_send_text' => strpos($content, '/send/text') !== false,
            'has_webhook_config' => strpos($content, '/webhook/config') !== false,
            'has_status' => strpos($content, '/status') !== false,
            'has_qr' => strpos($content, '/qr') !== false
        ];
        echo "‚úÖ $description: $file (" . strlen($content) . " bytes)\n";
        
        // Extrair endpoints espec√≠ficos
        if (preg_match_all('/\/[a-zA-Z0-9\/_-]+/g', $content, $matches)) {
            $unique_endpoints = array_unique($matches[0]);
            $whatsapp_endpoints = array_filter($unique_endpoints, function($endpoint) {
                return strpos($endpoint, '/send') !== false || 
                       strpos($endpoint, '/webhook') !== false || 
                       strpos($endpoint, '/status') !== false ||
                       strpos($endpoint, '/qr') !== false;
            });
            if (!empty($whatsapp_endpoints)) {
                echo "   üì° Endpoints: " . implode(', ', array_slice($whatsapp_endpoints, 0, 5)) . "\n";
            }
        }
    } else {
        echo "‚ùå $description: $file (N√ÉO ENCONTRADO)\n";
    }
}
echo "\n";

// ===== 5. AN√ÅLISE DAS CONFIGURA√á√ïES DA VPS =====
echo "5Ô∏è‚É£ ANALISANDO CONFIGURA√á√ïES DA VPS NO C√ìDIGO\n";
echo "--------------------------------------------\n";

$vps_ip = '212.85.11.238';
$vps_configs = [];

// Buscar todas as refer√™ncias √† VPS no c√≥digo
$search_patterns = [
    'VPS.*212\.85\.11\.238' => 'Refer√™ncias diretas √† VPS',
    '212\.85\.11\.238:3000' => 'Canal 3000',
    '212\.85\.11\.238:3001' => 'Canal 3001',
    'webhook.*config' => 'Configura√ß√µes de webhook',
    'PM2.*whatsapp' => 'Configura√ß√µes PM2'
];

foreach ($search_patterns as $pattern => $description) {
    $grep_result = shell_exec("grep -r \"$pattern\" . --include=\"*.php\" --include=\"*.js\" --include=\"*.md\" --include=\"*.sh\" 2>/dev/null | head -3");
    if ($grep_result) {
        echo "‚úÖ $description:\n";
        echo "   " . str_replace("\n", "\n   ", trim($grep_result)) . "\n";
    }
}
echo "\n";

// ===== 6. VERIFICAR STATUS ATUAL DA VPS =====
echo "6Ô∏è‚É£ VERIFICANDO STATUS ATUAL DA VPS\n";
echo "----------------------------------\n";

$vps_status = [];

// Verificar canal 3000
$ch = curl_init("http://$vps_ip:3000/status");
curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
curl_setopt($ch, CURLOPT_TIMEOUT, 10);
$response_3000 = curl_exec($ch);
$http_code_3000 = curl_getinfo($ch, CURLINFO_HTTP_CODE);
curl_close($ch);

if ($http_code_3000 === 200) {
    echo "‚úÖ Canal 3000: FUNCIONANDO (HTTP $http_code_3000)\n";
    $status_3000 = json_decode($response_3000, true);
    if ($status_3000) {
        echo "   üìä Status: " . ($status_3000['status'] ?? 'unknown') . "\n";
        echo "   üîó Porta: " . ($status_3000['port'] ?? 'unknown') . "\n";
    }
} else {
    echo "‚ùå Canal 3000: N√ÉO RESPONDE (HTTP $http_code_3000)\n";
}

// Verificar canal 3001
$ch = curl_init("http://$vps_ip:3001/status");
curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
curl_setopt($ch, CURLOPT_TIMEOUT, 10);
$response_3001 = curl_exec($ch);
$http_code_3001 = curl_getinfo($ch, CURLINFO_HTTP_CODE);
curl_close($ch);

if ($http_code_3001 === 200) {
    echo "‚úÖ Canal 3001: FUNCIONANDO (HTTP $http_code_3001)\n";
    $status_3001 = json_decode($response_3001, true);
    if ($status_3001) {
        echo "   üìä Status: " . ($status_3001['status'] ?? 'unknown') . "\n";
        echo "   üîó Porta: " . ($status_3001['port'] ?? 'unknown') . "\n";
    }
} else {
    echo "‚ùå Canal 3001: N√ÉO RESPONDE (HTTP $http_code_3001)\n";
}
echo "\n";

// ===== 7. VERIFICAR WEBHOOKS CONFIGURADOS =====
echo "7Ô∏è‚É£ VERIFICANDO WEBHOOKS CONFIGURADOS\n";
echo "------------------------------------\n";

// Verificar webhook canal 3000
$ch = curl_init("http://$vps_ip:3000/webhook/config");
curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
curl_setopt($ch, CURLOPT_TIMEOUT, 10);
$webhook_3000 = curl_exec($ch);
$webhook_http_3000 = curl_getinfo($ch, CURLINFO_HTTP_CODE);
curl_close($ch);

if ($webhook_http_3000 === 200) {
    echo "‚úÖ Webhook Canal 3000: CONFIGURADO\n";
    $webhook_config_3000 = json_decode($webhook_3000, true);
    if ($webhook_config_3000 && isset($webhook_config_3000['webhook_url'])) {
        echo "   üîó URL: {$webhook_config_3000['webhook_url']}\n";
    }
} else {
    echo "‚ùå Webhook Canal 3000: N√ÉO CONFIGURADO (HTTP $webhook_http_3000)\n";
}

// Verificar webhook canal 3001
$ch = curl_init("http://$vps_ip:3001/webhook/config");
curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
curl_setopt($ch, CURLOPT_TIMEOUT, 10);
$webhook_3001 = curl_exec($ch);
$webhook_http_3001 = curl_getinfo($ch, CURLINFO_HTTP_CODE);
curl_close($ch);

if ($webhook_http_3001 === 200) {
    echo "‚úÖ Webhook Canal 3001: CONFIGURADO\n";
    $webhook_config_3001 = json_decode($webhook_3001, true);
    if ($webhook_config_3001 && isset($webhook_config_3001['webhook_url'])) {
        echo "   üîó URL: {$webhook_config_3001['webhook_url']}\n";
    }
} else {
    echo "‚ùå Webhook Canal 3001: N√ÉO CONFIGURADO (HTTP $webhook_http_3001)\n";
}
echo "\n";

// ===== 8. GERAR RELAT√ìRIO DE AJUSTES NECESS√ÅRIOS =====
echo "8Ô∏è‚É£ RELAT√ìRIO DE AJUSTES NECESS√ÅRIOS\n";
echo "-----------------------------------\n";

$ajustes_necessarios = [];

// Verificar se webhooks est√£o configurados corretamente
$webhook_principal = 'https://app.pixel12digital.com.br/painel/receber_mensagem_ana_local.php';

if ($webhook_http_3000 !== 200 || 
    ($webhook_config_3000 && $webhook_config_3000['webhook_url'] !== $webhook_principal)) {
    $ajustes_necessarios[] = "Configurar webhook canal 3000 para: $webhook_principal";
}

if ($webhook_http_3001 !== 200) {
    $ajustes_necessarios[] = "Investigar API do canal 3001 (endpoints diferentes)";
}

// Verificar se canais est√£o conectados
if ($http_code_3000 !== 200) {
    $ajustes_necessarios[] = "Reiniciar canal 3000 na VPS";
}

if ($http_code_3001 !== 200) {
    $ajustes_necessarios[] = "Reiniciar canal 3001 na VPS";
}

// Verificar banco de dados
if (isset($mysqli) && $mysqli->connect_error) {
    $ajustes_necessarios[] = "Verificar conex√£o com banco de dados";
}

if (empty($ajustes_necessarios)) {
    echo "‚úÖ TODOS OS AJUSTES EST√ÉO CORRETOS!\n";
} else {
    echo "‚ö†Ô∏è AJUSTES NECESS√ÅRIOS:\n";
    foreach ($ajustes_necessarios as $i => $ajuste) {
        echo "   " . ($i + 1) . ". $ajuste\n";
    }
}
echo "\n";

// ===== 9. EXECUTAR AJUSTES AUTOM√ÅTICOS =====
echo "9Ô∏è‚É£ EXECUTANDO AJUSTES AUTOM√ÅTICOS\n";
echo "---------------------------------\n";

$ajustes_executados = 0;

// Ajuste 1: Configurar webhook canal 3000
if ($webhook_http_3000 !== 200 || 
    ($webhook_config_3000 && $webhook_config_3000['webhook_url'] !== $webhook_principal)) {
    
    echo "üîß Configurando webhook canal 3000...\n";
    
    $ch = curl_init("http://$vps_ip:3000/webhook/config");
    curl_setopt($ch, CURLOPT_POST, true);
    curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode(['url' => $webhook_principal]));
    curl_setopt($ch, CURLOPT_HTTPHEADER, ['Content-Type: application/json']);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_setopt($ch, CURLOPT_TIMEOUT, 10);
    
    $response = curl_exec($ch);
    $http_code = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    curl_close($ch);
    
    if ($http_code === 200) {
        echo "   ‚úÖ Webhook canal 3000 configurado com sucesso\n";
        $ajustes_executados++;
    } else {
        echo "   ‚ùå Erro ao configurar webhook canal 3000 (HTTP $http_code)\n";
    }
}

// Ajuste 2: Tentar configurar webhook canal 3001 (se API suportar)
if ($webhook_http_3001 !== 200) {
    echo "üîß Tentando configurar webhook canal 3001...\n";
    
    // Tentar diferentes endpoints
    $endpoints_3001 = ['/webhook/config', '/webhook', '/hook/config', '/hook'];
    $webhook_configurado_3001 = false;
    
    foreach ($endpoints_3001 as $endpoint) {
        $ch = curl_init("http://$vps_ip:3001$endpoint");
        curl_setopt($ch, CURLOPT_POST, true);
        curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode(['url' => $webhook_principal]));
        curl_setopt($ch, CURLOPT_HTTPHEADER, ['Content-Type: application/json']);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
        curl_setopt($ch, CURLOPT_TIMEOUT, 10);
        
        $response = curl_exec($ch);
        $http_code = curl_getinfo($ch, CURLINFO_HTTP_CODE);
        curl_close($ch);
        
        if ($http_code === 200) {
            echo "   ‚úÖ Webhook canal 3001 configurado via $endpoint\n";
            $webhook_configurado_3001 = true;
            $ajustes_executados++;
            break;
        }
    }
    
    if (!$webhook_configurado_3001) {
        echo "   ‚ö†Ô∏è Canal 3001 usa API diferente - necessita configura√ß√£o manual\n";
    }
}

// Ajuste 3: Atualizar banco de dados com status dos canais
if (isset($mysqli) && !$mysqli->connect_error) {
    echo "üîß Atualizando status dos canais no banco de dados...\n";
    
    $canais_para_atualizar = [
        ['identificador' => '554797146908@c.us', 'nome' => 'Pixel12Digital', 'status' => ($http_code_3000 === 200 ? 'conectado' : 'offline')],
        ['identificador' => '554797309525@c.us', 'nome' => 'Comercial - Pixel', 'status' => ($http_code_3001 === 200 ? 'conectado' : 'offline')]
    ];
    
    foreach ($canais_para_atualizar as $canal) {
        $sql = "INSERT INTO canais_comunicacao (tipo, identificador, nome_exibicao, status, data_conexao) 
                VALUES ('whatsapp', ?, ?, ?, NOW())
                ON DUPLICATE KEY UPDATE 
                status = VALUES(status), 
                data_conexao = NOW()";
        
        $stmt = $mysqli->prepare($sql);
        $stmt->bind_param('sss', $canal['identificador'], $canal['nome'], $canal['status']);
        $stmt->execute();
        
        echo "   ‚úÖ Canal {$canal['nome']} atualizado (Status: {$canal['status']})\n";
        $ajustes_executados++;
    }
}

echo "\nüìä AJUSTES EXECUTADOS: $ajustes_executados\n\n";

// ===== 10. RESUMO FINAL =====
echo "üîü RESUMO FINAL DA AVERIGUA√á√ÉO E AJUSTES\n";
echo "----------------------------------------\n";

echo "üéØ AVERIGUA√á√ÉO CONCLU√çDA!\n\n";

echo "üìã CONFIGURA√á√ïES IDENTIFICADAS NO C√ìDIGO:\n";
echo "‚Ä¢ VPS IP: $vps_ip\n";
echo "‚Ä¢ Canal 3000: " . ($http_code_3000 === 200 ? "‚úÖ Funcionando" : "‚ùå Offline") . "\n";
echo "‚Ä¢ Canal 3001: " . ($http_code_3001 === 200 ? "‚úÖ Funcionando" : "‚ùå Offline") . "\n";
echo "‚Ä¢ Webhook Principal: $webhook_principal\n";
echo "‚Ä¢ Webhook 3000: " . ($webhook_http_3000 === 200 ? "‚úÖ Configurado" : "‚ùå N√£o configurado") . "\n";
echo "‚Ä¢ Webhook 3001: " . ($webhook_http_3001 === 200 ? "‚úÖ Configurado" : "‚ùå API diferente") . "\n";
echo "‚Ä¢ Banco de dados: " . (isset($mysqli) && !$mysqli->connect_error ? "‚úÖ Conectado" : "‚ùå Erro") . "\n\n";

echo "üîß AJUSTES REALIZADOS: $ajustes_executados\n\n";

echo "üìö PR√ìXIMOS PASSOS:\n";
echo "1. Conectar WhatsApp no canal 3000 (gerar QR Code)\n";
echo "2. Investigar API do canal 3001 se necess√°rio\n";
echo "3. Testar envio de mensagens\n";
echo "4. Verificar painel de comunica√ß√£o\n\n";

echo "üìû COMANDOS √öTEIS:\n";
echo "‚Ä¢ Status VPS: curl http://$vps_ip:3000/status\n";
echo "‚Ä¢ QR Code: curl http://$vps_ip:3000/qr\n";
echo "‚Ä¢ Webhook: curl http://$vps_ip:3000/webhook/config\n";
echo "‚Ä¢ Logs: ssh root@$vps_ip 'pm2 logs --lines 20'\n\n";

echo "‚úÖ AVERIGUA√á√ÉO E AJUSTES FINALIZADOS COM SUCESSO!\n";
echo "üéâ VPS ajustada de acordo com o c√≥digo local!\n";
?> 